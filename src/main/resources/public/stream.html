<!DOCTYPE html>
<html>
<head>
    <title>Stream Test</title>
    <style>
        #messageForm {
            margin-bottom: 20px;
        }
        #messageInput {
            padding: 5px;
            margin-right: 10px;
        }
        #sendButton, #connectButton {
            padding: 5px 10px;
            margin-right: 10px;
        }
        #messages {
            font-family: monospace;
            white-space: pre-wrap;
        }
        .connected {
            background-color: #90EE90;
        }
        .disconnected {
            background-color: #FFB6C1;
        }
    </style>
</head>
<body>
    <button id="connectButton" class="disconnected">Connect</button>
    <form id="messageForm">
        <input type="text" id="messageInput" placeholder="Enter message">
        <button type="submit" id="sendButton">Send</button>
    </form>
    <div id="messages"></div>
    <script>
        const messagesDiv = document.getElementById('messages');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const connectButton = document.getElementById('connectButton');
        let reader = null;
        let decoder = null;

        // Function to start the stream
        function startStream() {
            fetch('http://localhost:8889/mcp')
                .then(response => {
                    reader = response.body.getReader();
                    decoder = new TextDecoder();
                    connectButton.textContent = 'Disconnect';
                    connectButton.classList.remove('disconnected');
                    connectButton.classList.add('connected');

                    function readStream() {
                        if (!reader) return;
                        
                        reader.read().then(({done, value}) => {
                            if (done) {
                                console.log('Stream complete');
                                // Don't disconnect, just clear the reader
                                reader = null;
                                return;
                            }

                            // Decode and process the chunk
                            const chunk = decoder.decode(value);
                            const lines = chunk.split('\n').filter(line => line.trim());
                            
                            lines.forEach(line => {
                                try {
                                    const data = JSON.parse(line);
                                    const p = document.createElement('p');
                                    p.textContent = JSON.stringify(data, null, 2);
                                    messagesDiv.appendChild(p);
                                } catch (e) {
                                    console.error('Error parsing JSON:', e);
                                }
                            });

                            // Continue reading
                            readStream();
                        });
                    }

                    readStream();
                })
                .catch(error => {
                    console.error('Error:', error);
                    disconnect();
                });
        }

        function disconnect() {
            if (reader) {
                reader.cancel();
                reader = null;
            }
            connectButton.textContent = 'Connect';
            connectButton.classList.remove('connected');
            connectButton.classList.add('disconnected');
        }

        // Handle connect button
        connectButton.onclick = function() {
            if (connectButton.textContent === 'Connect') {
                startStream();
            } else {
                disconnect();
            }
        };

        // Handle form submission
        messageForm.onsubmit = function(e) {
            e.preventDefault();
            const message = messageInput.value;
            if (message) {
                fetch('http://localhost:8889/mcp', {
                    method: 'POST',
                    body: message
                })
                .then(response => response.text())
                .then(text => {
                    const p = document.createElement('p');
                    p.textContent = text;
                    messagesDiv.appendChild(p);
                    messageInput.value = ''; // Clear input after sending
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        };
    </script>
</body>
</html> 